WITH DT1 AS (
           SELECT TO_DATE('2022-02-01','YYYY-MM-DD') AS BANK_DATE FROM DUAL),    ----first day of month
    DT2 AS (SELECT TO_DATE('2022-02-28','YYYY-MM-DD') AS BANK_DATE FROM DUAL),   ----last day of month
    DT3 AS (SELECT TO_DATE('2022-01-31','YYYY-MM-DD') AS BANK_DATE FROM DUAL),   ----last work day of last month
    DT4 AS (SELECT TO_DATE('2022-02-28','YYYY-MM-DD') AS BANK_DATE FROM DUAL),   ----last work day of month
    RATE AS (SELECT 0.12 AS RATE FROM DUAL),

    ---------------------------------------------------------------------FTP_FI-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    
    INCOME_FI AS (
SELECT 
RELATED_CONTRACT AS CONTRACT_REF_NO,
SOURCE_ID,
T1.GL_CODE,
T3.GEN_ID,
T2.LASTWORKDAYOFMONTH AS BANK_DATE, 
SUM(CASE WHEN DRCR = 'C' AND SUBSTR(T1.GL_CODE,2,1) IN ('0','1','2','3','4','5')  THEN LCY_AMOUNT 
        WHEN SUBSTR(T1.GL_CODE,2,1) IN ('0','1','2','3','4','5') THEN -LCY_AMOUNT END) AS INTEREST_INCOME_AZN,
SUM(CASE WHEN DRCR = 'C' AND SUBSTR(T1.GL_CODE,2,1) IN ('0','1','2','3','4','5')  THEN LCY_AMOUNT ELSE 0 END) AS CREDIT_INTEREST_INCOME_AZN,
SUM(CASE WHEN DRCR = 'D' AND SUBSTR(T1.GL_CODE,2,1) IN ('0','1','2','3','4','5')  THEN -LCY_AMOUNT ELSE 0 END) AS DEBIT_INTEREST_INCOME_AZN,
SUM(CASE WHEN DRCR = 'C' AND T1.GL_CODE = '670175501'  THEN LCY_AMOUNT WHEN T1.GL_CODE = '670175501' THEN -LCY_AMOUNT END) AS LOAN_CARD_COMMISSION_AZN
FROM DWH.F_TRANSACTION T1
JOIN DWH.D_CALENDAR T2 ON T1.BANK_DATE = T2.CALENDAR_DATE
JOIN DWH.D_ACCOUNT_PLAN_KB_DETAILS T3 ON T3.GL_CODE = T1.GL_CODE
where (bank_date BETWEEN (SELECT BANK_DATE FROM DT1) AND (SELECT BANK_DATE FROM DT2)) --DATES
AND (
T1.GL_CODE LIKE '60%'
OR T1.GL_CODE LIKE '61%'
OR T1.GL_CODE LIKE '62%'
OR T1.GL_CODE LIKE '63%'
OR T1.GL_CODE LIKE '64%'
OR T1.GL_CODE LIKE '65%'
OR T1.GL_CODE = '670175501'
)
AND USER_ID <> 'ZEUS_SYS'
AND EVENT NOT IN ('RPOS','YEND')
AND T3.GEN_ID IN ('G0101','G0102','G0103')
group by RELATED_CONTRACT, T1.SOURCE_ID, T2.LASTWORKDAYOFMONTH, SOURCE_ID, T1.GL_CODE, 
T3.GEN_ID

),

CURRENT_PORTFOLIO_FI AS (
        SELECT
            CA.LASTWORKDAYOFMONTH AS BANK_DATE,
            T1.CONTRACT_REF_NO,
            T1.SOURCE_ID,
            PRINCIPAL_AMOUNT_AZN AS TOTAL_PRINCIPAL_AMOUNT_AZN,
            INTEREST_AMOUNT_AZN AS TOTAL_INTEREST_AMOUNT_AZN,
            PREMIUM_AMOUNT_AZN,
            DISCOUNT_AMOUNT_AZN,
           CASE WHEN T1.PROVISION_PRINCIPAL_RATE >= 25 THEN T1.PROVISION_PRINCIPAL_AZN ELSE 0 END AS MEQSEDLI_EHTIYAT,
CASE WHEN T1.PROVISION_PRINCIPAL_RATE < 25 THEN T1.PROVISION_PRINCIPAL_AZN ELSE 0 END AS EHTIYAT,
T2.ECL_OF_USED_PART AS IFRS_EHTIYAT,
RW.RWA
            FROM
                 FRONT.DM_FI_PORTFOLIO T1
            JOIN DWH.D_CALENDAR CA ON CA.CALENDAR_DATE = T1.BANK_DATE
                                      AND CA.LASTWORKDAYOFMONTH = CA.CALENDAR_DATE
            LEFT JOIN risk.f_t_srp_provision_temp T2 ON T1.BANK_DATE = T2.REPORT_DATE 
AND T1.CONTRACT_REF_NO = T2.CONTRACT_REF_NO AND T1.SOURCE_ID = 1 AND T2.REPORT_DATE in (select bank_date from dt4) and t2.Balance in ('On_balance')
LEFT JOIN finance.D_RISK_WEIGHT RW ON RW.CONTRACT_REF_NO = T1.CONTRACT_REF_NO        
        WHERE
            T1.BANK_DATE in (SELECT BANK_DATE FROM DT4) --DATES
           
    ),
PREVIOUS_PORTFOLIO_FI AS (
        SELECT
            (select bank_date from dt2) AS BANK_DATE,
            T1.CONTRACT_REF_NO,
            T1.SOURCE_ID,
            PRINCIPAL_AMOUNT_AZN AS TOTAL_PRINCIPAL_AMOUNT_AZN,
            INTEREST_AMOUNT_AZN AS TOTAL_INTEREST_AMOUNT_AZN,
            PREMIUM_AMOUNT_AZN,
            DISCOUNT_AMOUNT_AZN,
           CASE WHEN T1.PROVISION_PRINCIPAL_RATE >= 25 THEN T1.PROVISION_PRINCIPAL_AZN ELSE 0 END AS MEQSEDLI_EHTIYAT,
CASE WHEN T1.PROVISION_PRINCIPAL_RATE < 25 THEN T1.PROVISION_PRINCIPAL_AZN ELSE 0 END AS EHTIYAT,
T2.ECL_OF_USED_PART AS IFRS_EHTIYAT,
RW.RWA
            FROM
                 FRONT.DM_FI_PORTFOLIO T1
            JOIN DWH.D_CALENDAR CA ON CA.CALENDAR_DATE = T1.BANK_DATE
                                      AND CA.LASTWORKDAYOFMONTH = CA.CALENDAR_DATE
LEFT JOIN (select REPORT_DATE,contract_ref_no,max(ECL_OF_USED_PART) as ECL_OF_USED_PART
from risk.f_t_srp_provision_temp 
where REPORT_DATE in (SELECT BANK_DATE FROM DT3) and Balance in ('On_balance')
group by contract_ref_no,REPORT_DATE)T2 ON T1.BANK_DATE = T2.REPORT_DATE 
AND T1.CONTRACT_REF_NO = T2.CONTRACT_REF_NO AND T1.SOURCE_ID = 1 AND T2.REPORT_DATE in (SELECT BANK_DATE FROM DT3)
LEFT JOIN finance.D_RISK_WEIGHT RW ON RW.CONTRACT_REF_NO = T1.CONTRACT_REF_NO 

        
        WHERE
            T1.BANK_DATE in(SELECT BANK_DATE FROM DT3) --DATES
           
    )



SELECT /*+FULL(T7) PARALLEL(20)*/
T1.BANK_DATE as REPORT_DATE,
CASE 
WHEN T10.SSL IS NOT NULL THEN 'MANAGEMENT_SUPPORTED'
ELSE 'TREASURY'
END AS FTP_BUSINESS_LINE,
NVL(T2.PRODUCT_CLASS,T2.DESCRIPTION) AS PRODUCT,
t1.cif,
t1.CONTRACT_NAME as CUSTOMER_NAME,
NULL AS FTP_TEYINAT,
TO_CHAR(T1.RATE) AS INTEREST,
TO_CHAR(T1.START_DATE,'YYYY-MM') AS START_DATE,
CASE WHEN T2.PRODUCT_CLASS = 'Avans' THEN 1 ELSE ROUND(MONTHS_BETWEEN(T1.MATURITY_DATE, T1.START_DATE)) end AS DURATION,
T1.CURRENCY,
CASE WHEN T1.CURRENCY IN ('AZN') THEN 'AZN' ELSE 'USD' END AS CURRENCY_ADJ,
SUM(CP.TOTAL_PRINCIPAL_AMOUNT_AZN + CP.PREMIUM_AMOUNT_AZN + CP.DISCOUNT_AMOUNT_AZN) AS PRINCIPAL,
SUM(CP.TOTAL_INTEREST_AMOUNT_AZN) AS TOTAL_INTEREST,
0 as PENALTY_AMOUNT,
0 AS COMISSION_AMOUNT,
SUM(CP.IFRS_EHTIYAT) AS IFRS_PROVISION,
SUM(CP.EHTIYAT) AS RESERVE,
SUM(CP.MEQSEDLI_EHTIYAT) AS MEQSEDLI_EHTIYAT,
CP.RWA AS RWA,
SUM(PP.TOTAL_PRINCIPAL_AMOUNT_AZN) AS PREV_TOTAL_PRINCIPAL_AMOUNT_AZN,----
SUM(PP.TOTAL_INTEREST_AMOUNT_AZN) AS PREV_TOTAL_INTEREST_AMOUNT_AZN,-----
SUM(CP.TOTAL_PRINCIPAL_AMOUNT_AZN) AS CP_TOTAL_PRINCIPAL_AMOUNT_AZN,----
SUM(CP.TOTAL_INTEREST_AMOUNT_AZN) AS CP_TOTAL_INTEREST_AMOUNT_AZN,-----
0 AS PREV_PENALTY_AMOUNT_AZN,
0 AS PREV_COMISSION_AMOUNT_AZN,
SUM(PP.MEQSEDLI_EHTIYAT) AS PREV_MEQSEDLI_EHTIYAT,
SUM(PP.EHTIYAT) AS PREV_EHTIYAT,
SUM(PP.IFRS_EHTIYAT) AS PREV_IFRS_EHTIYAT,
--PP.RWA AS PREV_RISK_DEGREE,
SUM(NVL(T7.INTEREST_INCOME_AZN,0)) AS INTEREST_INCOME,
CASE WHEN T10.SSL IS NOT NULL THEN NULL
ELSE 'MUDDETIN_SONU' END AS PAYMENT_PLAN_TYPE,
0 AS TAKSIT_QALIQ,
0 AS TAKSIT_TERM,
0 AS PREV_TAKSIT_QALIQ,
0 AS PREV_TAKSIT_TERM,
0 AS GRACE,
0 AS GRACE_PREV,
T7.GL_CODE,
T7.GEN_ID,
T1.CONTRACT_REF_NO
FROM DWH.F_CONTRACT_FI_HISTORY T1
LEFT JOIN DWH.D_PRODUCT T2 ON T1.PRODUCT_CODE = T2.CODE AND T1.SOURCE_ID = T2.SOURCE_ID AND T2.PRODUCT_TYPE = 0
LEFT JOIN FINANCE.V_CUSTOMER T3 ON T3.CIF = T1.CIF AND T1.SOURCE_ID = T3.SOURCE_ID
LEFT JOIN FINANCE.V_BD_A_SEGMENT_MONTHLY T12 ON T12.CIF = T1.CIF AND T12.BANK_DATE = T1.BANK_DATE
LEFT JOIN FINANCE.V_CONTRACT_TYPE T10 ON T10.CONTRACT_REF_NO = T1.CONTRACT_REF_NO AND T10.BANK_DATE = T1.BANK_DATE
LEFT JOIN INCOME_FI T7 ON T7.CONTRACT_REF_NO = T1.CONTRACT_REF_NO AND T1.SOURCE_ID = T7.SOURCE_ID
LEFT JOIN CURRENT_PORTFOLIO_FI CP ON CP.CONTRACT_REF_NO = T1.CONTRACT_REF_NO AND T1.SOURCE_ID = CP.SOURCE_ID AND CP.BANK_DATE = T1.BANK_DATE
LEFT JOIN PREVIOUS_PORTFOLIO_FI PP ON PP.CONTRACT_REF_NO = T1.CONTRACT_REF_NO AND T1.SOURCE_ID = PP.SOURCE_ID AND PP.BANK_DATE = T1.BANK_DATE
AND T1.BANK_DATE = CP.BANK_DATE
WHERE T1.BANK_DATE in (SELECT BANK_DATE FROM DT4) 
AND (CP.CONTRACT_REF_NO IS NOT NULL OR PP.CONTRACT_REF_NO IS NOT NULL OR T7.CONTRACT_REF_NO IS NOT NULL)
group by T1.BANK_DATE,T1.Contract_ref_no, CASE WHEN T10.SSL IS NOT NULL THEN 'MANAGEMENT_SUPPORTED' ELSE 'TREASURY' END, T10.SSL, 'MANAGEMENT_SUPPORTED', 'TREASURY', 
NVL(T2.PRODUCT_CLASS,T2.DESCRIPTION), T2.PRODUCT_CLASS, T2.DESCRIPTION, t1.CONTRACT_NAME, NULL, 
TO_CHAR(T1.RATE), T1.RATE, TO_CHAR(T1.START_DATE,'YYYY-MM'), T1.START_DATE, 'YYYY-MM', 
CASE WHEN T2.PRODUCT_CLASS = 'Avans' THEN 1 ELSE ROUND(MONTHS_BETWEEN(T1.MATURITY_DATE, T1.START_DATE)) end, T2.PRODUCT_CLASS, 'Avans', 1, ROUND(MONTHS_BETWEEN(T1.MATURITY_DATE, T1.START_DATE)), 
MONTHS_BETWEEN(T1.MATURITY_DATE, T1.START_DATE), T1.MATURITY_DATE, T1.START_DATE, T1.CURRENCY, CASE WHEN T1.CURRENCY IN ('AZN') THEN 'AZN' ELSE 'USD' END, 
T1.CURRENCY, 'AZN', 'AZN', 'USD', CP.RWA, 
T1.PRODUCT_CODE, t1.CIF, PP.RWA, CASE WHEN T10.SSL IS NOT NULL THEN NULL ELSE 'MUDDETIN_SONU' END, 
T10.SSL, NULL, 'MUDDETIN_SONU', T7.GL_CODE, T7.GEN_ID

union all

SELECT 
BANK_DATE as REPORT_DATE,
'TREASURY' AS FTP_BUSINESS_LINE,
'MM Yerləşdirilmiş Depozitlər' AS PRODUCT,
NULL AS cif,
NULL as CUSTOMER_NAME,
NULL AS FTP_TEYINAT,
NULL AS INTEREST,
NULL AS START_DATE,
NULL AS DURATION,
NULL AS CURRENCY,
NULL AS CURRENCY_ADJ,
NULL AS PRINCIPAL,
NULL AS TOTAL_INTEREST,
NULL as PENALTY_AMOUNT,
NULL AS COMISSION_AMOUNT,
NULL AS IFRS_PROVISION,
NULL AS RESERVE,
NULL AS MEQSEDLI_EHTIYAT,
NULL AS RWA,
NULL AS PREV_TOTAL_PRINCIPAL_AMOUNT_AZN,
NULL AS PREV_TOTAL_INTEREST_AMOUNT_AZN,
NULL AS CP_TOTAL_PRINCIPAL_AMOUNT_AZN,----
NULL AS CP_TOTAL_INTEREST_AMOUNT_AZN,-----
NULL AS PREV_PENALTY_AMOUNT_AZN,
NULL AS PREV_COMISSION_AMOUNT_AZN,
NULL AS PREV_MEQSEDLI_EHTIYAT,
NULL AS PREV_EHTIYAT,
NULL AS PREV_IFRS_EHTIYAT,
--PP.RWA AS PREV_RISK_DEGREE,
INTEREST_INCOME_AZN AS INTEREST_INCOME,
NULL AS PAYMENT_PLAN_TYPE,
NULL AS TAKSIT_QALIQ,
NULL AS TAKSIT_TERM,
NULL AS PREV_TAKSIT_QALIQ,
NULL AS PREV_TAKSIT_TERM,
NULL AS GRACE,
NULL AS GRACE_PREV,
GL_CODE,
GEN_ID,
CONTRACT_REF_NO
FROM INCOME_FI WHERE CONTRACT_REF_NO IS NULL

